---
##Set timezone
- name: set timezone
  shell: timedatectl set-timezone Europe/Moscow

#Install Chrony to time Sync

- name: Synchronize datetime | Install chrony
  apt:
    name: chrony
    state: latest
  tags:
    - backupserver-datesync

#Enable Chrony Services to time Sync

- name: Synchronize datetime | Turn on chronyd
  service:
    name: chronyd
    enabled: yes
    state: started
  notify:
    - systemctl daemon reload
  tags:
    - backupserver-datesync


# Устанавливаем инструменты анализа сети
- name: install base tools
  apt:
    name:
      - traceroute
      - tcpdump
      - net-tools
      - mtr
      - curl
      - iperf3
    state: present
    update_cache: true
  tags:
    - netanalize



# #install NetworkManager


# - name: Install NetworkManager
#   apt:
#     name: NetworkManager
#     state: present
#   tags:
#     - NetworkManager

# #install NetworkManager


# - name: Install NetworkManager
#   apt:
#     name: NetworkManager
#     state: present
#   tags:
#     - NetworkManager


#disable ufw firewall
- name: Disable ufw services if enabled
  shell: "if systemctl is-enabled --quiet {{ item }}; then systemctl disable {{ item }} && echo disable_ok ; fi"
  register: output
  changed_when: "'disable_ok' in output.stdout"
  loop:
    - ufw
  tags:
    - ufwoff
    - inetrouter





 #enable forwarding for interfaces
- name: set up forward packages across routers
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
  notify:
    - systemctl daemon reload


#enable forwarding for interfaces
- name: set up forward packages across routers
  sysctl:
    name: net.ipv4.conf.all.forwarding
    value: '1'
    state: present
  notify:
    - systemctl daemon reload

#enable forwarding 6 for interfaces
- name: set up forward 6 packages across routers
  sysctl:
    name: net.ipv6.conf.all.forwarding
    value: '1'
    state: present
  notify:
    - systemctl daemon reload


#disable do not accept ICMP redirects 
- name: disable do not accept ICMP redirects 
  sysctl:
    name: net.ipv4.conf.all.accept_redirects
    value: '0'
    state: present
  notify:
    - systemctl daemon reload


#disable do not accept ICMP redirects 
- name: disable do not accept ICMP redirects 
  sysctl:
    name: net.ipv4.conf.all.send_redirects
    value: '0'
    state: present
  notify:
    - systemctl daemon reload


#Install IPSEC

- name: Install Strongswan package
  apt:
    name: strongswan
    state: present

- name: Enable IPSEC Service
  service:
    name: ipsec
    enabled: true
  notify:
    - restart IPSEC   

## NFTables

- name: Enable NFTables
  service:
    name: nftables
    enabled: yes
    state: started
  notify:
    - systemctl daemon reload
  tags:
    - nftables




 